
# =======================================================
# KONFIGURASI NGINX FINAL - ANTI 403 & ANTI MIME-TYPE
# =======================================================

# 1. Pastikan izin folder sudah benar:
sudo chmod 755 /home/clusterkobapwk
sudo chmod 755 /home/clusterkobapwk/warung-app
sudo chmod 755 /home/clusterkobapwk/warung-app/sim-rw
sudo chmod 644 /home/clusterkobapwk/warung-app/sim-rw/*.html
sudo chmod 644 /home/clusterkobapwk/warung-app/sim-rw/*.tsx
sudo chmod 644 /home/clusterkobapwk/warung-app/sim-rw/*.ts
sudo chmod 644 /home/clusterkobapwk/warung-app/sim-rw/*.css

# 2. Edit Config: sudo nano /etc/nginx/sites-available/default
# GANTI ISINYA DENGAN INI:

server {
    listen 80;
    server_name _;

    root /home/clusterkobapwk/warung-app/sim-rw;
    index index.html;

    # Blokir fallback ke index.html untuk file source code agar tidak terjadi SyntaxError '<'
    location ~* \.(tsx|ts|js|jsx|css|png|jpg|jpeg|gif|ico|svg)$ {
        try_files $uri =404;
        
        # Tambahkan MIME type secara manual untuk memastikan browser/Babel mau membacanya
        if ($request_filename ~* \.(tsx|ts)$ ) {
            add_header Content-Type application/javascript;
        }
    }

    location / {
        # Hanya gunakan index.html untuk rute navigasi (bukan file fisik)
        try_files $uri $uri/ /index.html;
    }

    # PROXY API KE PORT 5000
    location /api/ {
        proxy_pass http://localhost:5000/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}

# 3. Restart Nginx
# sudo nginx -t
# sudo systemctl restart nginx
